#! /bin/bash

# Copyright Alex <blackcat.myako@gmail.com>. 
#
#      This program is free software; you can redistribute it and/or modify
#      it under the terms of the GNU General Public License as published by
#      the Free Software Foundation; either version 2 of the License, or
#      (at your option) any later version.
#
#      This program is distributed in the hope that it will be useful,
#      but WITHOUT ANY WARRANTY; without even the implied warranty of
#      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#      GNU General Public License for more details.
#
#      You should have received a copy of the GNU General Public License
#      along with this program; if not, write to the Free Software
#      Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
#
############################# LiveInstall #################################

# LiveInstall can:
# - installs zour ZenLive environment to the harddisk.
#
# version='0.5'  # - 28/12/2007		- first version ( basic install )
# version='0.6'  # - 29/12/2007		- modular install
# version='0.7'  # - 29/12/2007		- lilosetup works now silent
# version='0.8'  # - 31/12/2007		- locale-setup works now silent
#									- useradd
#									- desktop choice
#									- config files setup ( xorg.conf, modprobe.conf , ... )
# version='0.9'  # - 12/01/2008		- many bugfixes
#									- liloconfig errors fixed
#									- removes unneeded files
#									- preconfigs added ( Core , Base , Full )
#									- fixed zenlite modules bugs
#

. /usr/lib/liblinuxlive

# Set the locale in en_US, to avoid problems with Xlib
export LANG=${LANG:-en_US}

# Needed variables
export PATH="${PATH}:/usr/bin/:/usr/libexec/"
export buffer=/tmp/liveinstall_dir
export zenlive_folder=/mnt/live/mnt/*/$LIVECDNAME
export swapprt=`fdisk -l | grep swap | cut -f1 -d " "`

# cleanup stuff
rm -rf $buffer
mkdir -p $buffer
if [ -e /var/log/liveinstall.log ]; then
	rm /var/log/liveinstall.log
fi
touch /var/log/liveinstall.log

# create listfiles
cd $zenlive_folder
find base modules optional -name "*.lzm" 2>/dev/null | sort > $buffer/list_install
cat $buffer/list_install > $buffer/buffer
grep -v "zenlite-base.lzm" $buffer/buffer > $buffer/list_install
rm $buffer/buffer
cat $buffer/list_install > $buffer/buffer
grep -v "zenlite-desktop.lzm" $buffer/buffer > $buffer/list_install
rm $buffer/buffer
touch $buffer/list_remove

partrm=`fdisk -l | grep dev -m 1 | cut -f2 -d " " | sed 's/://'`
printf "%s\n" "# LILO configuration file" > $buffer/genlilo.conf
printf "%s\n" "# Generated by LiloFix" >> $buffer/genlilo.conf
printf "%s\n" "#" >> $buffer/genlilo.conf
printf "%s\n" "# Start LILO global section" >> $buffer/genlilo.conf
printf "%s\n" "append=\"splash=silent \"" >> $buffer/genlilo.conf
printf "%s\n" "boot = $partrm" >> $buffer/genlilo.conf	
printf "%s\n" "bitmap=/boot/splash.bmp" >> $buffer/genlilo.conf
printf "%s\n" "bmp-table=234p,348p,1,4" >> $buffer/genlilo.conf
printf "%s\n" "bmp-colors=220,0,,255,220," >> $buffer/genlilo.conf
printf "%s\n" "bmp-timer=539p,396p,220,0," >> $buffer/genlilo.conf
printf "%s\n" "prompt" >> $buffer/genlilo.conf
printf "%s\n" "timeout = 50" >> $buffer/genlilo.conf
printf "%s\n" "# Override dangerous defaults that rewrite the partition table:" >> $buffer/genlilo.conf
printf "%s\n" "change-rules" >> $buffer/genlilo.conf
printf "%s\n" "  reset" >> $buffer/genlilo.conf
printf "%s\n" "# VESA framebuffer console @ 1024x768x64k" >> $buffer/genlilo.conf
printf "%s\n" "vga = 791" >> $buffer/genlilo.conf
printf "%s\n" "# End LILO global section" >> $buffer/genlilo.conf

# Start LiveInstall
. /usr/libexec/liveinstall-gui

gtkdialog -i /usr/libexec/liveinstall-functions --program=MAIN_DIALOG 

exit
