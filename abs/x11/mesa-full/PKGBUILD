# Maintainer: LEW21 <lew21@xtreeme.org>

pkgname=mesa-full
pkgver=20091022
_realver=7.7
pkgrel=1
pkgdesc="Full Mesa 3D graphics library with all its components, built from the git master branch."
arch=(i686 x86_64)
url="http://mesa3d.org/"
license=('LGPL')
depends=('drm-radeon-module-git-r6xx-r7xx-3d' 'libdrm>=2.4.15' 'dri2proto>=2.1' 'glproto>=1.4.10' 'libxxf86vm' 'libxdamage' 'expat>=2.0.1')
makedepends=('pkgconfig')
provides=("libgl=${_realver}", "mesa=${_realver}", "glut=${_realver}", "ati-dri=${_realver}", "intel-dri=${_realver}", "mach64-dri=${_realver}", "mga-dri=${_realver}", "r128-dri=${_realver}", "savage-dri=${_realver}", "tdfx-dri=${_realver}", "unichrome-dri=${_realver}")
replaces=('libgl', 'mesa', 'glut', 'ati-dri', 'intel-dri', 'mach64-dri', 'mga-dri', 'r128-dri', 'savage-dri', 'tdfx-dri', 'unichrome-dri')
conflicts=('libgl', 'mesa', 'glut', 'ati-dri', 'intel-dri', 'mach64-dri', 'mga-dri', 'r128-dri', 'savage-dri', 'tdfx-dri', 'unichrome-dri')
options=(!makeflags)

_gitroot="git://anongit.freedesktop.org/git/mesa/mesa"
_gitname="mesa"

build() {
	msg "Connecting to git.freedesktop.org GIT server...."

	if [ -d $startdir/src/$_gitname ] ; then
		cd $_gitname && git pull origin
		msg "The local files are updated."
	else
		git clone $_gitroot
	fi

	msg "GIT checkout done or server timeout"
	msg "Starting make..."

	rm -rf $startdir/src/$_gitname-build
	cp -r $startdir/src/$_gitname $startdir/src/$_gitname-build
	cd $startdir/src/$_gitname-build

	cd "${startdir}/src/mesa-build"
	./autogen.sh --prefix=/usr \
	--with-dri-driverdir=/usr/lib/xorg/modules/dri \
	--enable-glx-tls \
	--with-driver=dri \
	--enable-xcb \
	--enable-egl \
	--enable-glu \
	--enable-glut \
	--enable-glw \
	--enable-gallium \
	--enable-gallium-intel \
	--enable-gallium-radeon || return 1
	make || return 1
	make DESTDIR="${pkgdir}" install || return 1

	install -m755 -d "${pkgdir}/usr/lib/xorg/modules/extensions"
	ln -sf libglx.xorg ${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so || return 1

	install -m755 -d "${pkgdir}/usr/bin"
	install -m755 progs/xdemos/glxinfo progs/xdemos/glxgears ${startdir}/pkg/usr/bin/
}
